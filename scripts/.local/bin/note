#!/usr/bin/sh

# Wrapper script for storing markup notes in pass.
# See "note -h" for more details.
#
# Dependencies:
# - gpg, md5sum
# - dmenu, fzf
# - md2html (md4c)
# - groff (+mom macros)
# - neatroff (+ms, mm, rnd macros)
# - surf (html viewing)
# - env: $PDF_READER (fallback to zathura)
# - ntmake (my script for quick neatroff compilation)
# - git
# - tar
#
# For neatroff rnd macros see https://github.com/randoragon/tmac-rnd

# CONFIG
notedir="${XDG_DATA_HOME:-~/.local/share}/notes"
gpgid="$notedir/.gpg-id"

help () {
    printf "\
Usage:
    note [OPTIONS] [NAME]

    Without the NAME argument, note will let you select a note for
    viewing with either dmenu or fzf.
    To create a new note, pass the NAME argument (with extension).

Options:
    -e, --edit
        Open note for editing instead of viewing. This implies that
        the note already exists (NAME cannot be passed).

    -t, --textonly
        View any markup note as plain text.

    -h, --help
        Display this help text.

NAME Extensions:
    *.txt
        Plain text. If no extension in NAME is present, \".txt\"
        will be appended automatically.

    *.md
        Markdown

    *.rnd
        Neatroff + rnd macros
        See https://github.com/randoragon/tmac-rnd

    *.mm
        Neatroff + mm macros

    *.ms
        Neatroff + ms macros

    *.mom
        groff + mom macros

"
}

# extract <archive> <dir>
# Decrypts and extracts an archive into dir
extract () {
    tmp="$(mktemp --tmpdir note.XXXXX)"
    chmod 600 -- "$tmp"
    printf "Decrypting \"%s\" into \"%s\"...\n" "$1" "$tmp"
    gpg --yes --quiet --output "$tmp" --decrypt -- "$1"
    tar -xzf "$tmp" -C "$2"
    shred -u -- "$tmp"
}

# archive <basedir> <dir> <archive> <gpuid>
# The opposite of extract, requires gpgid for encryption
# basedir is the root directory of the archive
# dir must be the NAME (not path) of a directory within basedir
archive () {
    tmp="$(mktemp --tmpdir note.XXXXX)"
    chmod 600 -- "$tmp"
    tar -C "$1" -czf "$tmp" -- "$2"
    gpg --yes --quiet --output "$3" --encrypt --recipient "$4" -- "$tmp"
    shred -u -- "$tmp"
}

# edit <archive>
# archive - path to the note archive file, relative to $notedir
edit () {
    [ ! -r "$gpgid" ] && echo "note: .gpg-id file not found, aborting." >&2 && exit 3
    tmpd="$(mktemp --tmpdir -d note.XXXXX)"
    chmod 700 -- "$tmpd"
    extract "$notedir/$1" "$tmpd"
    fname="$(basename -- "$1")"
    target="$tmpd/$fname/$fname"
    [ ! -f "$target" ] && echo "error: file not found" >&2 && exit 4
    sum=
    sum="$(md5sum -- "$target")"
    if [ -z "$interactive" ]; then
        st -e "$EDITOR" "$target"
    else
        "$EDITOR" "$target"
    fi
    if [ "$(md5sum -- "$target")" = "$sum" ]; then
        echo "No changes were made, skipping."
    else
        archive "$tmpd" "$fname" "$notedir/$1" "$(cat -- "$gpgid")"
        git -C "$notedir" add "$1"
        git -C "$notedir" commit -o "$1" -m "Edit $1"
    fi
    find "$tmpd" -type f -exec shred -x '{}' \;
    rm -r -- "$tmpd"
}

# view <archive>
# archive - path to the note archive file, relative to $notedir
view () {
    tmpd="$(mktemp --tmpdir -d note.XXXXX)"
    chmod 700 -- "$tmpd"
    extract "$notedir/$1" "$tmpd"
    fname="$(basename -- "$1")"
    target="$tmpd/$fname/$fname"
    fmt="${1##*.}"
    [ -n "$textonly" ] && fmt=txt
    case "$fmt" in
        txt)
            if [ -z "$interactive" ]; then
                st -e "$PAGER" -- "$target"
            else
                "$PAGER" -- "$target"
            fi
            ;;
        md)
            tmp="$(mktemp -p "$tmpd/$1" "note.XXXXX.html")"
            printf "%s" "$HTML_TABLE_STYLE" >"$tmp"
            md2html --github "$target" >>"$tmp"
            [ -s "$tmp" ] && surf "file://$tmp"
            ;;
        rnd)
            ntmake -rnd <"$target" | "${PDF_READER:-zathura}" -
            ;;
        ms)
            ntmake -ms <"$target" | "${PDF_READER:-zathura}" -
            ;;
        mm)
            ntmake -mm <"$target" | "${PDF_READER:-zathura}" -
            ;;
        mom)
            pdfmom -k -e -p -t "$target" | "${PDF_READER:-zathura}" -
            ;;
        *)
            printf "note: unknown note format \"%s\"\n" "$fmt" >&2
    esac
    find "$tmpd" -type f -exec shred -x '{}' \;
    rm -rf -- "$tmpd"
}

# create <note>
# note is a path of a new note relative to notedir
create () {
    tmpd="$(mktemp --tmpdir -d note.XXXXX)"
    fname="$(basename -- "$1")"
    mkdir -p "$tmpd/$fname"
    target="$tmpd/$fname/$fname"
    :>"$target"
    sum=
    sum="$(md5sum -- "$target")"
    if [ -z "$interactive" ]; then
        st -e "$EDITOR" "$target"
    else
        "$EDITOR" "$target"
    fi
    if [ "$(md5sum -- "$target")" = "$sum" ]; then
        echo "File unchanged, cancelling."
    else
        archive "$tmpd" "$fname" "$notedir/$1" "$(cat -- "$gpgid")"
        git -C "$notedir" add "$1"
        git -C "$notedir" commit -o "$1" -m "Create $1"
        mkdir -p "$notedir/$(dirname -- "$fname")"
    fi
    find "$tmpd" -type f -exec shred -x '{}' \;
    rm -r -- "$tmpd"
}

edit=
textonly=
opts="$(getopt -n note -s sh -o het -l help,edit,textonly -- "$@")"
eval set -- "$opts"
while true; do
    case "$1" in
        -h|--help) help ; exit ; shift ;;
        -e|--edit) edit=1 ; shift ;;
        -t|--textonly) textonly=1 ; shift ;;
        --) shift ; break ;;
        *) break ;;
    esac
done

[ ! -d "$notedir" ] && echo "note: notes dir not found" >&2 && exit 1

# View/edit existing note
if [ $# -eq 0 ]; then

    # Check if shell is interactive. For interactive
    # shells use fzf, otherwise use dmenu.
    interactive=
    if [ -z "$edit" ]; then prompt="View Note:"; else prompt="Edit Note:"; fi
    if [ -t 0 ]; then
        note="$(cd "$notedir" && find . -type f -not -path '\./\.*' -exec realpath --relative-to "$notedir" '{}' \; \
            | fzf --no-sort --no-multi --prompt "$prompt ")"
        interactive=1
    else
        note="$(cd "$notedir" && find . -type f -not -path '\./\.*' -exec realpath --relative-to "$notedir" '{}' \; \
            | dmenu -F -l 5 -p "$prompt")"
    fi

    [ -z "$note" ] && exit
    if [ -z "$edit" ]; then
        view "$note"
    else
        edit "$note"
    fi

# Create new note
else
    [ -n "$textonly" ] && echo "note: illegal use of --textonly option" >&2 && exit 2
    [ -n "$edit" ] && echo "note: illegal use of --edit option" >&2 && exit 2
    fname="$*"
    [ -z "$(basename -- "$fname")" ] && echo "note: cannot create a note with empty filename" >&2 && exit 2

    ext=.txt
    case "$fname" in
        *.md)  ext= ;;
        *.rnd) ext= ;;
        *.ms)  ext= ;;
        *.mm)  ext= ;;
        *.mom) ext= ;;
        *.txt) ext= ;;
    esac
    [ -e "$notedir/$fname$ext" ] && echo "note: a note with the same name already exists" >&2 && exit
    create "$fname$ext"
fi
