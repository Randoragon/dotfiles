#!/usr/bin/sh

# Search all notes for a substring. For more details
# on notes read comments inside the note script.
#
# This script doesn't use any long-term cache,
# which causes it to be heavy and slow. Use it only
# when you actually need to perform a serious search.
#
# Dependencies:
# - ag (the_silver_searcher)
# - gpg

notedir="${XDG_DATA_HOME:-~/.local/share}/notes"
[ ! -d "$notedir" ] && echo "agnote: notes dir not found" >&2 && exit 1

dir="$(mktemp --tmpdir -d agnote.XXXXX)"
chmod 700 "$dir"

# Recreate directory structure
find "$notedir" -mindepth 1 -type d -not -path '*/\.git*' -exec realpath --relative-to "$notedir" '{}' \; \
    | while read -r nestdir; do
    mkdir -p "$dir/$nestdir"
done

# Decrypt & copy over all notes
export dir
find "$notedir" -type f -not -path '*/\.git*' -name "?*.?*" | while read -r f; do
    relpath="$(realpath --relative-to "$notedir" -- "$f")"
    gpg --yes --quiet --decrypt --output "$dir/$relpath" -- "$f"
done

# Search for the query
ag -H --color "$@" "$dir" | less -R

# Shred sensitive data
find "$dir" -type f -print0 | xargs -0 shred -x
rm -rf -- "$dir"
