#!/usr/bin/sh

# This script lets you select any entry from pass via dmenu,
# then will prompt you for key password if necessary, and
# finally it will copy decrypted content in such a way that
# if there's a user field available, the first paste will
# paste the user, and the second will paste the first line
# of the file. If there's no user available, just the first
# line will be copied.
#
# Mild Warning: this script will restart gpg-agent every time
# it runs due to the necessity of swapping the pinentry program.
#
# Dependencies:
# - dmenu
# - pinentry-gtk-2 (doesn't need to be symlinked to /usr/bin/pinentry)
# - libnotify

passdir="${PASSWORD_STORE_DIR:-HOME/.password-store}"
icon="/usr/share/icons/Adwaita/96x96/status/task-due-symbolic.symbolic.png"
script=~/.scripts/passcpy-subscript

[ ! -x "$script" ] && notify-send "passcpy" "Failed to locate\nscript executable" && exit 1

password="$( \
    find "$passdir" -type f -name "*.gpg" -exec realpath --relative-to "$passdir" "{}" \; \
    | sed 's/\.gpg$//' \
    | dmenu "$@" \
)"

[ -z "$password" ] && exit

export password
gpgconf --kill gpg-agent
gpg-agent --pinentry-program=/usr/bin/pinentry-gtk-2 --daemon "$script"
gpgconf --kill gpg-agent
