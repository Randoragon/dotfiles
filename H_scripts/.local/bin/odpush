#!/bin/sh

# This script first mirrors some files and directories into the local
# ~/OneDrive/Sync directory, and then mirrors the contents of that dir
# to the remote OneDrive/Sync directory.
# 
# DEPENDENCIES
# - OneDrive Client for Linux (https://github.com/abraunegg/onedrive)

# This represents the remote OneDrive root directory
odroot="$HOME/OneDrive"

# This holds the output of the last onedrive command
log="$HOME/.cache/odpush-latest.log"

# Argument 1: source path (follows rsync's trailing slash convention)
# The data will be saved inside the Sync directory on OneDrive
push () {
    [ $# -ne 1 ] && echo "odpush: push: invalid number of arguments" && return 1
    src="$1" dest="Sync"
    [ ! -d "$src" ] && [ ! -f "$src" ] && echo "odpush: push: invalid path $(tput setaf 1)$src$(tput setaf 7)" >&2 && return 1
    [ -n "$dest" ] && [ ! -d "$odroot/$dest" ] && mkdir -p -- "$odroot/$dest"
    printf "\b%s\n" "$(tput bold)Synchronizing $(tput setaf 2)$src$(tput setaf 7) to $(tput setaf 3)$odroot/$dest$(tput setaf 7)...$(tput sgr0)"
    rsync -vuctr --delete -- "$src" "$odroot/$dest"
    printf "\n%s\n" "$(tput bold)Uploading $(tput setaf 2)$src$(tput setaf 7) to $(tput setaf 3)/$dest$(tput setaf 7)...$(tput sgr0)"
    onedrive --synchronize --upload-only --single-directory "$dest" 2>&1 | tee "$log"
    grep -q 'ERROR' "$log" && notify-send -u critical "odpush" "An error occurred while uploading to OneDrive.\nSee <b>$(printf "%s" "$log" | sed "s/\/home\/[^/]*/\~/")</b>\nfor more information."
}

push ~/Music
