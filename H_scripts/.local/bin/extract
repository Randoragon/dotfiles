#!/bin/sh

# Extracts any common archive format into a custom directory
# Simple wrapper for tar, unzip, rar, jar and 7z.
#
# Options:
# -v, --verbose
# lists all the files getting extracted
#
# Two parameters:
# extract ARCHIVE [DIRECTORY]
# if ARCHIVE is -, reads stdin
# if no DIRECTORY, assumes the same name ARCHIVE~

# Parse options
OPTS="$(getopt -n extract -s sh -o v -l --verbose -- "$@")"
eval set -- "$OPTS"
verbose=
while true; do
    case "$1" in
        -v|--verbose) verbose=1 ; shift ;;
        --) shift ; break ;;
        *) break ;;
    esac
done

# Check argument count
[ $# -eq 0 ] && echo "extract: Not enough arguments." && exit 1

# Handle stdin
[ "$1" = '-' ] && {
    read line
    "$0" "$line" "$2"
    exit
}

# Parse arguments
ar="$(realpath -- "$1")"
[ $# -gt 1 ] && nm="$2" || nm="$(basename -- "$1")"'~'
[ -f "$nm" -o -d "$nm" ] && echo "extract: '$nm' already exists." && exit 2

# Extract
case "$ar" in
    *.tar|*.tar.gz|*.tar.bz|*.tar.xz|*.tar.bz2|*.tbz|*.tbz2|*.tgz|*.txz)
        mkdir -p -- "$nm"
        [ -n "$verbose" ] && opts='-xvf' || opts='-xf'
        tar "$opts" "$ar" -C "$nm"
    ;;
    *.zip|*.dvi)
        [ -n "$verbose" ] && unzip "$ar" -d "$nm" || unzip -q "$ar" -d "$nm"
    ;;
    *.rar)
        mkdir -p -- "$nm"
        [ -n "$verbose" ] && rar x "$ar" "$nm" || rar -idq x "$ar" "$nm"
    ;;
    *.jar)
        mkdir -p -- "$nm"
        prevpwd="$PWD"
        cd -- "$nm"
        [ -n "$verbose" ] && opts='xvf' || opts='xf'
        jar "$opts" "$ar"
        cd -- "$PWD"
    ;;
    *.7z)
        [ -n "$verbose" ] && 7z x "$ar" -o"$nm" || 7z x "$ar" -o"$nm" >&-
    ;;
esac

